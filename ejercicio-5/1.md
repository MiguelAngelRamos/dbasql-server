
# üß™ Ejercicio Guiado: Replicaci√≥n de Mezcla en SQL Server entre dos servidores

---

## üéØ Objetivo del ejercicio

Configurar un escenario de replicaci√≥n de mezcla entre dos servidores SQL Server, donde:

* El primer servidor (Publisher) publica una base de datos.
* El segundo servidor (Subscriber) recibe los datos.
* Se configura una carpeta compartida para los snapshots.
* Se realiza la suscripci√≥n tipo **Pull**, con resoluci√≥n de conflictos predeterminada.

---

## üß© Requisitos previos

* Tener **dos servidores SQL Server** funcionando (instancia local o en red).
* Ambos con SQL Server Management Studio instalado.
* Conexi√≥n de red funcional entre ambos servidores.

---

## üìò Parte 1: Preparar el entorno en el **Servidor Publisher**

### 1Ô∏è‚É£ Crear la base de datos en el servidor Publisher

```sql
CREATE DATABASE BibliotecaReplica;
GO

USE BibliotecaReplica;
GO

CREATE TABLE Usuarios (
    ID INT PRIMARY KEY,
    Nombre NVARCHAR(100),
    rowguid UNIQUEIDENTIFIER ROWGUIDCOL NOT NULL DEFAULT NEWID()
);
GO

INSERT INTO Usuarios (ID, Nombre) VALUES (1, 'Pedro'), (2, 'Luc√≠a');
```

---

### 2Ô∏è‚É£ Crear carpeta compartida para snapshots

1. En el disco `C:\` crea una carpeta llamada: `Replicacion`

2. Haz clic derecho ‚Üí `Propiedades` ‚Üí `Sharing` ‚Üí `Advanced Sharing`

   * Marca "Compartir esta carpeta"
   * Nombre de recurso compartido: `Replicacion`
   * Permisos: `Everyone = Change`

3. Luego ve a la pesta√±a **Security**:

   * Haz clic en `Edit`
   * Selecciona el usuario con el que ejecutas SQL Server ‚Üí marca la casilla `Modify`

4. Probar desde el segundo servidor (Subscriber) que puedas acceder:

   ```
   Ejecutar (Win + R) ‚Üí \\PUBLISHER\Replicacion
   ```

---

### 3Ô∏è‚É£ Configurar el Distribution y Publisher en SSMS

1. En el **Publisher**, abre `SSMS` ‚Üí ve a `Replication` ‚Üí clic derecho ‚Üí `Configure Distribution`
2. Paso a paso:

   * Elige que **este servidor act√∫e como distribuidor**
   * Define carpeta de snapshots: `\\PUBLISHER\Replicacion`
   * Nombre de la base de distribuci√≥n: `distribution`
   * Marcar que este servidor tambi√©n ser√° Publisher
   * Finaliza el asistente

---

### 4Ô∏è‚É£ Crear una publicaci√≥n (Merge Replication)

1. `Replication` ‚Üí `Local Publications` ‚Üí clic derecho ‚Üí `New Publication`
2. Selecciona la base de datos: `BibliotecaReplica`
3. Tipo de replicaci√≥n: **Merge Replication**
4. Compatibilidad: `SQL Server 2008 or later`
5. Selecciona la tabla `Usuarios` como art√≠culo
6. No aplicar filtros
7. Instant√°nea:

   * Quitar la programaci√≥n cada 14 d√≠as
   * Marcar: **Crear instant√°nea inmediatamente**
8. Seguridad del Snapshot Agent: usar cuenta SQL Server (`sa`)
9. Nombre de la publicaci√≥n: `PublicationBiblioteca`

---

## üìò Parte 2: Configurar el **Servidor Subscriber**

### 5Ô∏è‚É£ Crear base de datos local para la suscripci√≥n

```sql
CREATE DATABASE BibliotecaReplica_Sub;
GO
```

---

### 6Ô∏è‚É£ Crear suscripci√≥n desde el Subscriber

1. En el Subscriber: `Replication` ‚Üí `Local Subscriptions` ‚Üí clic derecho ‚Üí `New Subscription`
2. Buscar el Publisher por nombre de red o IP ‚Üí seleccionar la publicaci√≥n `PublicationBiblioteca`
3. Tipo de suscripci√≥n: **Pull Subscription**
4. Base de datos del Subscriber: `BibliotecaReplica_Sub`
5. Configurar el agente:

   * Ejecutar continuamente
6. Inicializar:

   * Marcar **Inicializar inmediatamente**
7. Resoluci√≥n de conflictos:

   * Tipo de suscripci√≥n: **Client**
   * Gana el primer cambio que se sincroniza

---

## üìä Parte 3: Verificaci√≥n y pruebas

### 7Ô∏è‚É£ Insertar datos diferentes en Publisher y Subscriber

```sql
-- En el Publisher:
USE BibliotecaReplica;
UPDATE Usuarios SET Nombre = 'Juan' WHERE ID = 1;

-- En el Subscriber:
USE BibliotecaReplica_Sub;
UPDATE Usuarios SET Nombre = 'Carlos' WHERE ID = 1;
```

---

### 8Ô∏è‚É£ Forzar sincronizaci√≥n

* En el Subscriber ‚Üí clic derecho sobre la suscripci√≥n ‚Üí `View Synchronization Status` ‚Üí `Start`
* Abrir `Replication Monitor` para ver si se detect√≥ conflicto
* Verificar cu√°l valor qued√≥ en ambas bases

---

## üìå Observaciones clave

* Si no cambias nada, **el Publisher tiene prioridad** y ganar√° su valor.
* Puedes ir a `Replication Monitor` ‚Üí `Conflicts` ‚Üí analizar si hubo conflictos.
* Esto demuestra c√≥mo funciona **la resoluci√≥n autom√°tica predeterminada** de SQL Server Merge Replication.

---
